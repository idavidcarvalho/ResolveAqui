{% extends 'core/base.html' %}
{% block title %}Gerenciar Chamados — ResolveAqui{% endblock %}

{% block content %}
<div class="container-fluid px-3 px-md-4" style="min-height:60vh;">
  <div class="d-flex justify-content-between align-items-center mb-3 mb-md-4 flex-wrap gap-2">
    <div class="d-flex align-items-center">
      <a href="{% url 'tickets:dashboard' %}" class="btn btn-sm btn-outline-secondary me-2 me-md-3">
        <i class="bi bi-speedometer2"></i>
      </a>
      <h2 class="h6 h5-md mb-0"><i class="bi bi-list-check me-2 d-none d-sm-inline"></i>Gerenciar Chamados</h2>
    </div>
  </div>

  <!-- Filtros -->
  <div class="card mb-3 mb-md-4">
    <div class="card-body">
      <form method="get" class="row g-2 g-md-3">
        <div class="col-6 col-md-3">
          <label class="form-label small">Status</label>
          <select name="status" class="form-select form-select-sm form-select-md">
            <option value="">Todos</option>
            {% for value, label in status_choices %}
              <option value="{{ value }}" {% if current_filters.status == value %}selected{% endif %}>{{ label }}</option>
            {% endfor %}
          </select>
        </div>

        <div class="col-6 col-md-3">
          <label class="form-label small">Área</label>
          <select name="area" class="form-select form-select-sm form-select-md">
            <option value="">Todas</option>
            {% for area in areas %}
              <option value="{{ area.id }}" {% if current_filters.area|stringformat:"s" == area.id|stringformat:"s" %}selected{% endif %}>{{ area.name }}</option>
            {% endfor %}
          </select>
        </div>

        <div class="col-6 col-md-3">
          <label class="form-label small">Problema</label>
          <select name="problem" class="form-select form-select-sm form-select-md">
            <option value="">Todos</option>
            {% for problem in problems %}
              <option value="{{ problem.id }}" {% if current_filters.problem|stringformat:"s" == problem.id|stringformat:"s" %}selected{% endif %}>{{ problem.name }}</option>
            {% endfor %}
          </select>
        </div>

        <div class="col-6 col-md-3">
          <label class="form-label small">Usuário</label>
          <select name="user" class="form-select form-select-sm form-select-md">
            <option value="">Todos</option>
            {% for user in users %}
              <option value="{{ user.id }}" {% if current_filters.user|stringformat:"s" == user.id|stringformat:"s" %}selected{% endif %}>{{ user.firstName }} {{ user.lastName }}</option>
            {% endfor %}
          </select>
        </div>

        <div class="col-12 col-md-9">
          <label class="form-label small">Buscar</label>
          <input type="text" name="q" class="form-control form-control-sm form-control-md" placeholder="Buscar..." value="{{ current_filters.search|default:'' }}">
        </div>

        <div class="col-12 col-md-3 d-flex align-items-end gap-2">
          <button type="submit" class="btn btn-primary btn-sm flex-fill flex-md-grow-0"><i class="bi bi-search me-1 d-none d-md-inline"></i>Filtrar</button>
          <a href="{% url 'tickets:all_tickets' %}" class="btn btn-outline-secondary btn-sm flex-fill flex-md-grow-0"><i class="bi bi-x-circle me-1 d-none d-md-inline"></i>Limpar</a>
        </div>
      </form>
    </div>
  </div>

  <!-- Tabela de Tickets -->
  <div class="card">
    <div class="card-body p-0">
      <div class="table-responsive">
        <table class="table table-hover mb-0 table-sm table-md">
          <thead class="table-light">
            <tr>
              <th style="width:60px;">#</th>
              <th>Problema</th>
              <th>Distrito</th>
              <th>Usuário</th>
              <th>Status</th>
              <th>Atualizado</th>
              <th style="width:120px;">Ações</th>
            </tr>
          </thead>
          <tbody>
            {% for ticket in tickets %}
              <tr>
                <td class="text-muted">{{ ticket.pk }}</td>
                <td>
                  <strong>{% if ticket.problem %}{{ ticket.problem.name }}{% else %}Sem problema{% endif %}</strong>
                  {% if ticket.problem and ticket.problem.area %}
                    <br><small class="text-muted"><i class="bi bi-tag me-1"></i>{{ ticket.problem.area.name }}</small>
                  {% endif %}
                </td>
                <td><i class="bi bi-geo-alt me-1"></i>{{ ticket.district }}</td>
                <td>
                  {{ ticket.created_by.firstName }} {{ ticket.created_by.lastName }}
                  <br><small class="text-muted">{{ ticket.created_by.email }}</small>
                </td>
                <td>
                  <select class="form-select form-select-sm status-selector" data-ticket-id="{{ ticket.pk }}">
                    {% for value, label in status_choices %}
                      <option value="{{ value }}" {% if ticket.status == value %}selected{% endif %}>{{ label }}</option>
                    {% endfor %}
                  </select>
                </td>
                <td class="small">
                  <i class="bi bi-clock me-1"></i>{{ ticket.updated_at|date:"d/m/Y H:i" }}
                </td>
                <td>
                  <a href="{% url 'tickets:detail' ticket.pk %}" class="btn btn-sm btn-outline-primary">
                    <i class="bi bi-eye"></i>
                  </a>
                </td>
              </tr>
            {% empty %}
              <tr>
                <td colspan="7" class="text-center py-4 text-muted">
                  <i class="bi bi-inbox" style="font-size:2rem;"></i>
                  <p class="mt-2 mb-0">Nenhum chamado encontrado.</p>
                </td>
              </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <div class="mt-3 text-muted small">
    <i class="bi bi-info-circle me-1"></i>Total: {{ tickets.count }} chamado(s)
  </div>
</div>

<style>
/* Responsividade para tabela */
@media (max-width: 768px) {
  .table-responsive table {
    font-size: 0.85rem;
  }
  .table th, .table td {
    padding: 0.5rem 0.3rem;
  }
  .form-select-sm {
    font-size: 0.8rem;
    padding: 0.25rem 0.5rem;
  }
}
</style>

<script>
// Atualizar status via AJAX
document.querySelectorAll('.status-selector').forEach(select => {
  select.addEventListener('change', function() {
    const ticketId = this.dataset.ticketId;
    const newStatus = this.value;
    const originalStatus = this.querySelector('option[selected]').value;

    fetch(`/tickets/${ticketId}/update-status/`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/x-www-form-urlencoded',
        'X-CSRFToken': '{{ csrf_token }}'
      },
      body: `status=${encodeURIComponent(newStatus)}`
    })
    .then(response => response.json())
    .then(data => {
      if (data.success) {
        // Atualizar interface
        this.querySelector('option[selected]').removeAttribute('selected');
        this.querySelector(`option[value="${newStatus}"]`).setAttribute('selected', 'selected');

        // Mostrar feedback
        const row = this.closest('tr');
        row.style.backgroundColor = '#d4edda';
        setTimeout(() => {
          row.style.backgroundColor = '';
        }, 1000);
      } else {
        alert('Erro ao atualizar status: ' + (data.error || 'Erro desconhecido'));
        this.value = originalStatus;
      }
    })
    .catch(error => {
      console.error('Erro:', error);
      alert('Erro ao atualizar status');
      this.value = originalStatus;
    });
  });
});
</script>
{% endblock %}
